# Руководство разработчика к проекту NInja Turtle

Данное руководство предоставляет инофрмацию о том, как установить, сконфигурировать и запустить програмное обеспечение для управления проектом. Прежде чем работать с ROS, настоятельно рекомендуем изучить архитектуру и организацию файлов в ROS. Для этого можно воспользоваться [официальными мануалами](http://wiki.ros.org/ROS/Tutorials).

### План действий:
1. Установка образа операционной системы на Raspberry Pi.
2. Базовая конфигурация управляющего компьютера с ОС Ubuntu-20.04.
3. Установка необходимых ros-пакетов на оба компьютера.
4. Конфигурация соединения между компьютерами
5. Запуск системы ROS
6. Расширение функционала
7. Аппаратная часть

> Необходимость использовать два компьютера с ROS возникает из-за ресурсоемкости визуализации определенного функционала робота и работы алгоритмов перемещения. Выполнение таких операций целиком на Raspberry может быть непозволительно медленным, но благодаря тому, что ROS позволяет создавать распределенную архитектуру, вычислительные модули находятся в разных подсистемах.


## 1. Установка образа на Raspberry Pi  

Для начала работы на Raspberry Pi нам необходима SD-карта с образом операционной системы.  
Мы выбрали ОС [Lubuntu 16.04 LTS](https://ubiquity-pi-image.sfo2.digitaloceanspaces.com/2023-02-09-ubiquity-base-gdm3-focal-raspberry-pi.img.xz), к тому же в скачиваемом образе уже содержится дистрибутив ROS Noetic. Можно установить и другие версии ubuntu, поддерживающие ROS Noetic и отдельно установить ROS Noetic:

sudo apt install ros-noetic-desktop

Для деталей установки смотреть [официальную документацию ROS](http://wiki.ros.org/noetic/Installation/Ubuntu).
.  
Для установки образа ОС на SD карту рекомендуем возпользоваться программой [Rufus](https://rufus.ie/ru/), облегчающей процесс записи больших файлов на диски.

## 2. Базовая конфигурация управляющего компьютера

Установка ROS на настольный компьютер ничем не отличается от установки ROS на Raspberry. Вам по-прежнему нужно отталкиваться от версии Linux, которая установлена на вашем настольном компьютере.

В нашем случае компьютер работает под Ubuntu 20.04.1 LTS (Focal), поэтому на него мы так же устанавливаем ROS Noetic.

Можно воспользоваться [русско-язычным руководством](https://amperka.ru/blogs/projects/abot-robot-part-1#ros-setup) по установке всех подсистем в схожем проекте. 

## 3. Установка необходимых пакетов на оба компьютера

Пакеты являются функциональными программными модулями, создаваемыми вручную либо устонавливаемые с помощью утилиты rosdep.

Для установки созданных нами пакетов скачайте [наш проект](https://gitlab.se.ifmo.ru/jjj/projects.git), перейдите в папку *sources* и выполните команду:

    catkin_make

Эти пакеты позволяют управлять движением робота и использовать утилиту для отображения rviz, чтобы симулировать управление модулью робота в компьютере.

Информацию об остальных пакетах, работа которых ещё не налажена, смотрите главу 6.

## 4. Конфигурация соединения между компьютерами

На этом этапе нужно подключить оба компьютера к одной сети Wi-fi и сконфигурировать нектороые файлы для того, чтобы между компьютерами было ROS соединение.

С помощью утилит *ifconfig* и *ip addr* посмотрите Ip адрес ваших компьютеров в текущей сети Wi-Fi - эти адреса будут выглядеть следующим образом: 192.168.\*.\*

Любым удобным способом на обоих компьютерах отредактируйте файл */etc/hosts* - добавьте строки вида:  

    *ip_адрес_управляющего_компьютера имя_пользователя_управляющего_компьютера*
    *ip_адрес_бортового_компьютера имя_пользователя_бортового_компьютера*

> Убедительно советуем проверять ip адреса каждой из машин перед началом работы, так как роутеры имеют свойство менять ip адреса подключаемых устройств. Если такое произошло, просто повторите пердыдущие шаги из этой главы

После этого добавим переменные окружения на каждую машину. На настольном компьютере укажите следующее:

    echo "ROS_MASTER_URI=http://[здесь имя пользователя на настольном компьютере]:11311" >> ~/.bashrc
    echo "ROS_HOSTNAME=[здесь тоже имя пользователя на настольном компьютере]" >> ~/.bashrc
    echo "ROS_IP=[здесь ip адрес настольного компьютера]" >> ~/.bashrc

На Raspberry выполните следующие аналогичные предыдущим команды:

    echo "ROS_MASTER_URI=http://[здесь имя пользователя на настольном компьютере]:11311" >> ~/.bashrc
    echo "ROS_HOSTNAME=[здесь имя пользователя на бортовом компьютере]" >> ~/.bashrc
    echo "ROS_IP=[здесь ip адрес бортового компьютера]" >> ~/.bashrc

После этого перезагрузите оба компьютера. Затем запустите ядро ROS на настольном компьютере:

    roscore

На бортовом компьютере проверьте есть ли соединение следующей командой:

    rostopic list

Если ничего не появилось или чего хуже какие-либо сообщения об ошибках, предлагаем обратиться к [документации ROS по этому вопросу](http://wiki.ros.org/ROS/Tutorials/MultipleMachines).

## 5. Запуск системы ROS

Подключите энкодеры и бортовой компьютер к питанию от батарей и переключите выключатель. 

Для смены направления вращения колес, необходимо поменять подключение управляющих проводов к плате Raspberry согласно схеме подаваемого напряжения (С GPIO с выходом 0/1 на выход 1/0).

## 6. Расширение функционала

Предполагалось, что робот сможет считывать данные с лидара и согласно slam-алгоритму передвигаться, чтобы обследовать все помещение и в процессе этого, отравлять информацию о полученных точках, чтобы управляющий компьютер строил карту. К сожалению, этот функционал не реализован в настоящей версии системы. Мы возлагаем эту задачу на вас - людей которые сейчас это читают. 

Для работы лидара существуют ROS-пакеты, упрощающие установку драйверов и взаимодействие с устройством. Перечень паектов:

* [urg_node](http://wiki.ros.org/urg_node) - новейший все ещё поддерживаемый
* [hokuyo_node](http://wiki.ros.org/hokuyo_node) - устаревший

## 7. Аппаратная часть

Для поддержания работоспособности робота необходимо проверять уровень заряда батарей и по необходимости заряжать их. 

Для проверки заряда рекомендуется использовать мультиметр.

Для подзарядки аккумуляторов рекомендуется использовать универсальное зарядное устройство (можно найти по адресу: *Санкт-Петербург, Биржевая линия 14, к. 358*).